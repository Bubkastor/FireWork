<!DOCTYPE html>
<html>
<head>
    <title>SignalR Fireworks</title>
    <style type="text/css">
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>


    <script src="Scripts/babylon.2.1.debug.js"></script>
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <script src="signalr/hubs"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function () {

        var chat = $.connection.clientHub;

        var canvas = document.getElementById('renderCanvas');

        // load the 3D engine
        var engine = new BABYLON.Engine(canvas, true);

        // createScene function that creates and return the scene
        var createScene = function () {
            var scene = new BABYLON.Scene(engine);

            var camera = new BABYLON.TargetCamera('camera1', new BABYLON.Vector3(0, 0, 10), scene);
            camera.setTarget(BABYLON.Vector3.Zero());
            camera.attachControl(canvas, false);
            var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);

            var wall = BABYLON.Mesh.CreatePlane("wall", 40.0, scene);
            wall.material = new BABYLON.StandardMaterial("wallMat", scene);
            wall.material.emissiveColor = new BABYLON.Color3(1, 1, 1);


            scene.onPointerDown = function (evt, pickResult) {
                if (pickResult.hit) {
                    var x = pickResult.pickedPoint.x;
                    var y = pickResult.pickedPoint.y;
                    var position = new BABYLON.Vector3(x, y, 0);
                    $.connection.hub.start().done(function(){
                        chat.server.send(x, y);
                    });

                    //CreateBoom(scene, position);
                }
            };

            return scene;
        };

        function CreateBoom(scene, position){
            var fountain = BABYLON.Mesh.CreateBox("foutain", 0.1, scene);
            fountain.visibility = 0.0;
            fountain.position = position ;

            var particleSystem = new BABYLON.ParticleSystem("particles", 2000, scene);
            particleSystem.particleTexture = new BABYLON.Texture("textures/flare.png", scene);

            particleSystem.emitter = fountain;

            particleSystem.minEmitBox = new BABYLON.Vector3(0, 0, 0);
            particleSystem.maxEmitBox = new BABYLON.Vector3(0, 0, 0);

            particleSystem.color1 = new BABYLON.Color4(1.0, 0.0, 0.0, 1.0);
            particleSystem.color2 = new BABYLON.Color4(0.0, 1.0, 0.0, 1.0);

            particleSystem.colorDead = new BABYLON.Color4(0.0, 0.0, 0.0, 0.5);

            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.2;

            particleSystem.minLifeTime = 0.3;
            particleSystem.maxLifeTime = 0.7;

            particleSystem.emitRate = 1500;

            particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;

            particleSystem.gravity = new BABYLON.Vector3(0, -11, 0);

            particleSystem.direction1 = new BABYLON.Vector3(1, 1, 0);
            particleSystem.direction2 = new BABYLON.Vector3(-1, 1, 0);

            particleSystem.minAngularSpeed = 0;
            particleSystem.maxAngularSpeed = Math.PI;

            particleSystem.minEmitPower = 1;
            particleSystem.maxEmitPower = 4;
            particleSystem.updateSpeed = 0.003;

            particleSystem.start();
            setTimeout(function(){
                particleSystem.stop();
                setTimeout(function(){
                    fountain.dispose();
                }, 3000);

            }, 500);

        }

        var scene = createScene();
        chat.client.broadcastMessage = function (x, y) {
            var position = new BABYLON.Vector3(x, y, 0);
            CreateBoom(scene, position);
        };

        engine.runRenderLoop(function () {
                scene.render();
        });

        window.addEventListener('resize', function () {
                engine.resize();
        });

//


});
    </script>
</body>
</html>